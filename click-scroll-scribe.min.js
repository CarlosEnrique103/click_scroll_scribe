!function(){"use strict";if("boolean"==typeof window.consentGiven&&!window.consentGiven)return void console.log("Tracking disabled: User consent not provided");let e={clicks:[],scrolls:[],timeOnPage:[]};const n={debounceTime:200,batchInterval:5e3,apiEndpoint:"https://heatmap-api-kqm7.onrender.com/api/v1/heatmap/register",scrollMilestones:[25,50,75,100]};let t=0,i=Date.now(),o={},a=null;function c(){try{localStorage.setItem("trackingData",JSON.stringify(e))}catch(n){if(console.error("Error saving to localStorage:",n),"QuotaExceededError"===n.name){!function(){e.clicks.length>20&&(e.clicks=e.clicks.slice(Math.floor(e.clicks.length/2)));e.scrolls.length>20&&(e.scrolls=e.scrolls.slice(Math.floor(e.scrolls.length/2)));e.timeOnPage.length>10&&(e.timeOnPage=e.timeOnPage.slice(Math.floor(e.timeOnPage.length/2)))}();try{localStorage.setItem("trackingData",JSON.stringify(e))}catch(e){console.error("Still unable to save data after pruning:",e)}}}}function r(){if(a&&clearTimeout(a),window.disableTracking)return;if(0===e.clicks.length&&0===e.scrolls.length&&0===e.timeOnPage.length)return void(a=setTimeout(r,n.batchInterval));const t=JSON.parse(JSON.stringify(e));fetch(n.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),keepalive:!0}).then((e=>{if(!e.ok)throw new Error("Network response was not ok: "+e.status);return e.json()})).then((()=>{console.log("Tracking data sent successfully")})).catch((e=>{console.error("Error sending tracking data:",e)})).finally((()=>{a=setTimeout(r,n.batchInterval)}))}function s(){document.addEventListener("click",(function(i){if(window.disableTracking)return;const o=Date.now();if(o-t<n.debounceTime)return;t=o;const a=function(e){if(!(e&&e instanceof Element))return"unknown";const n=e.tagName.toLowerCase(),t=e.id?`#${e.id}`:"",i=Array.from(e.classList).map((e=>`.${e}`)).join(""),o=e.textContent?e.textContent.trim().substring(0,20):"";return{tag:n,identifier:t||i||o||n,fullSelector:l(e)}}(i.target),r=document.documentElement.scrollHeight||window.innerHeight,s=i.pageX/window.innerWidth*100,d=i.pageY/r*100,g={x:i.clientX,y:i.clientY,xPercent:Number(s.toFixed(2)),yPercent:Number(d.toFixed(2)),pageX:i.pageX,pageY:i.pageY,element:a,timestamp:(new Date).toISOString()};e.clicks.push(g),c()}),{passive:!0})}function l(e,n=3){if(!(e&&e instanceof Element))return"unknown";let t="",i=e,o=0;for(;i&&i!==document.body&&o<n;){let e=i.tagName.toLowerCase();if(i.id)e+=`#${i.id}`;else if(i.classList.length>0){e+=`.${Array.from(i.classList).join(".")}`}t=t?`${e} > ${t}`:e,i=i.parentElement,o++}return t}function d(){let t;n.scrollMilestones.forEach((e=>{o[e]=!1})),window.addEventListener("scroll",(function(){window.disableTracking||t||(t=setTimeout((function(){t=null;const i=function(){const e=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),n=window.innerHeight||document.documentElement.clientHeight,t=window.pageYOffset||document.documentElement.scrollTop,i=e-n;return i>0?Math.floor(t/i*100):0}();n.scrollMilestones.forEach((n=>{if(i>=n&&!o[n]){o[n]=!0;const t={percentage:n,timestamp:(new Date).toISOString()};e.scrolls.push(t),c()}}))}),100))}),{passive:!0})}function g(){console.log("Initializing Click-Scroll-Scribe tracking with heatmap..."),function(){const n=localStorage.getItem("trackingData");if(n)try{e=JSON.parse(n)}catch(n){console.error("Error parsing stored tracking data:",n),e={clicks:[],scrolls:[],timeOnPage:[]}}}(),s(),d(),function(){function t(){const e=Date.now();return Math.floor((e-i)/1e3)}i=Date.now(),setInterval((function(){if(window.disableTracking)return;const n=t();if(n%30==0&&n>0){const t={seconds:n,timestamp:(new Date).toISOString()};e.timeOnPage.push(t),c()}}),1e3),window.addEventListener("beforeunload",(function(){if(window.disableTracking)return;const i=t();if(i>0){const t={seconds:i,finalVisit:!0,timestamp:(new Date).toISOString()};e.timeOnPage.push(t),c();const o=JSON.stringify({data:e,pageUrl:window.location.href,userAgent:navigator.userAgent,timestamp:(new Date).toISOString(),event:"page_exit"});navigator.sendBeacon&&navigator.sendBeacon(n.apiEndpoint,o)}}))}(),window.addEventListener("message",(function(n){if(n.data&&"iframe-click"===n.data.type){const t=n.data.data;if(window.disableTracking)return;t.source="iframe",e.clicks.push(t),c(),updateHeatmap(t),console.log("Tracked click from iframe:",t)}})),a=setTimeout(r,n.batchInterval),window.ClickScrollScribe={disableTracking:function(){window.disableTracking=!0,console.log("Tracking disabled")},enableTracking:function(){window.disableTracking=!1,console.log("Tracking enabled")},isEnabled:function(){return!window.disableTracking}},window.disableTracking?console.log("Tracking initialized but disabled due to window.disableTracking setting"):console.log("Tracking initialized and active")}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",g):g()}();